@inject NavigationManager NavManager
@rendermode InteractiveServer

@inject JournalService JournalService

<div class="calendar">
    <div class="calendar__header">
        <h1 class="calendar__header-title">
            @CalendarStartDate.ToString(format: "MMMM yyyy")
        </h1>
    </div>

    <div class="calendar__contents">
        <div class="calendar__contents--day-of-week">
            @foreach (string day in DayOfWeek)
            {
                <div class="calendar__day-name">@day</div>
            }
        </div>

        <div class="calendar__contents--grid">
            @for (int i = 0; i < CalendarCells.Count; i++)
            {
                CalendarCell? day = CalendarCells[i];
                string dayClass = day != null ? "day--current" : "day--padding";
                int dayValue = day != null && day.Date != null ? day.Date.Value.Day : 0;

                <div @onclick=@(e => DirectToJournal(day)) class="day @dayClass" value="@(dayValue > 0 ? dayValue : "")">
                    @if (day != null && day.Date != null)
                    {
                        <p class="day-desc">@day.Date.Value.Day</p>
                    }
                </div>
            }
        </div>
    </div>
</div>

@code {
    [CascadingParameter]
    private Task<AuthenticationState> AuthState { get; set; } = default!;
    private ClaimsPrincipal? _user;
    private string? _userId;

    private int year;
    private int month;
    DateTime CalendarStartDate;
    List<string> DayOfWeek = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

    protected override async Task OnInitializedAsync()
    {
        AuthenticationState? authState = await AuthState;
        _user = authState.User;
        _userId = _user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        Uri? uri = NavManager.ToAbsoluteUri(NavManager.Uri);

        var query = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query);

        // get param and parse to int and create a datetime obj
        if ((query.TryGetValue("year", out var yearValue)) && query.TryGetValue("month", out var monthValue))
        {
            bool yearParseResult = int.TryParse(yearValue, out year);
            bool monthParseResult = int.TryParse(monthValue, out month);

            if (monthParseResult && yearParseResult)
            {
                CalendarStartDate = new DateTime(year: year, month: month, day: 1);
                return;
            }
        }

        CalendarStartDate = DateTime.Today;
    }

    void DirectToJournal(CalendarCell? cell)
    {
        if (cell == null || cell.Date == null) return;

        DateTime date = (DateTime)cell.Date;
        string dateString = date.ToString("yyy-MM-dd");
        NavManager.NavigateTo($"/journal?date={dateString}");
    }

    class CalendarCell
    {
        public DateTime? Date { get; set; }
        public bool IsCurrentMonth { get; set; }
    }

    List<CalendarCell> CalendarCells => GenerateCalendarCells();

    List<CalendarCell> GenerateCalendarCells()
    {
        List<CalendarCell>? cells = new List<CalendarCell>();

        int firstDayIndex = (int)CalendarStartDate.DayOfWeek;
        // didn't know you can do that but converts day of week to a integer value

        for (int i = 0; i < firstDayIndex - 1; i++)
        {
            cells.Add(item: new CalendarCell { Date = null, IsCurrentMonth = false });
        }

        int daysInMonth = DateTime.DaysInMonth(CalendarStartDate.Year, CalendarStartDate.Month);
        for (int i = 1; i <= daysInMonth; i++)
        {
            cells.Add(item: new CalendarCell
            {
                Date = new DateTime(CalendarStartDate.Year, CalendarStartDate.Month, i),
                IsCurrentMonth = true
            });
        }

        while (cells.Count < 42)
        {
            cells.Add(item: new CalendarCell { Date = null, IsCurrentMonth = false });
        }

        return cells;
    }
}